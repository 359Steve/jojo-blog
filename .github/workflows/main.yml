name: Deploy to Aliyun Server

on:
    push:
        branches: [main, master]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: å®‰è£…ä¾èµ–
              run: |
                  npm config set registry https://registry.npmmirror.com
                  npm ci

            - name: æ„å»ºé¡¹ç›®
              run: npm run build

            - name: å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆé¢„ç¼–è¯‘åŸç”Ÿæ¨¡å—ï¼‰
              run: |
                  rm -rf node_modules
                  npm install --omit=dev

            - name: æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
              run: tar -czf deploy.tar.gz .output node_modules ecosystem.config.js package*.json

            - name: ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  source: 'deploy.tar.gz'
                  target: '/tmp/'

            - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  script: |
                      cd ${{ secrets.DEPLOY_PATH }}
                      echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
                      rm -rf .output node_modules
                      echo "ğŸ“¦ è§£å‹æ„å»ºæ–‡ä»¶..."
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz
                      echo "ğŸ”„ é‡å¯åº”ç”¨..."
                      pm2 restart nuxt-app || pm2 start ecosystem.config.js --name nuxt-app
                      echo "âœ… éƒ¨ç½²å®Œæˆï¼"
                      pm2 status nuxt-app

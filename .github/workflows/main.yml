name: Deploy to Aliyun Server

on:
    push:
        branches: [main, master]
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½®Node.jsç¯å¢ƒ
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: å®‰è£…ä¾èµ–
              run: |
                  npm config set registry https://registry.npmmirror.com
                  npm ci

            - name: æ„å»ºé¡¹ç›®
              run: npm run build

            - name: å‹ç¼©æ„å»ºäº§ç‰©ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
              run: tar -czf deploy.tar.gz .output ecosystem.config.js

            - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°æœåŠ¡å™¨
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  source: 'deploy.tar.gz'
                  target: '/tmp/'

            - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  script: |
                      cd ${{ secrets.DEPLOY_PATH }}
                      echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz
                      echo " é‡å¯åº”ç”¨..."
                      pm2 restart nuxt-app || pm2 start ecosystem.config.js --name nuxt-app
                      echo "âœ… éƒ¨ç½²å®Œæˆï¼"
                      pm2 status nuxt-app

name: Deploy to Aliyun Server

on:
    push:
        branches: [main, master]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
              run: |
                  npm config set registry https://registry.npmmirror.com
                  npm ci
                  npx prisma generate
                  npm run build

            - name: å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆé¢„ç¼–è¯‘åŸç”Ÿæ¨¡å—ï¼‰
              run: |
                  rm -rf node_modules
                  npm ci --omit=dev

            - name: æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
              run: tar -czf deploy.tar.gz .output node_modules ecosystem.config.js package*.json prisma/migrations

            - name: ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  source: 'deploy.tar.gz'
                  target: '/tmp/'

            - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  script: |
                      cd ${{ secrets.DEPLOY_PATH }} || exit 1

                      echo "ğŸ§¹ æ¸…ç†æ—§ä¸´æ—¶æ–‡ä»¶..."
                      rm -rf /tmp/deploy.tar.gz

                      echo "ğŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬..."
                      if [ -d ".output" ]; then
                        mv .output output_backup_$(date +%Y%m%d_%H%M%S)
                      fi
                      if [ -d "node_modules" ]; then
                        mv node_modules node_modules_backup_$(date +%Y%m%d_%H%M%S)
                      fi

                      echo "ğŸ“¦ è§£å‹æ–°ç‰ˆæœ¬..."
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz

                      echo "ğŸ“‚ éƒ¨ç½² Prisma è¿ç§»..."
                      if [ -d "prisma/migrations" ]; then
                        npx prisma migrate deploy || true
                      fi

                      echo "ğŸ”„ é‡å¯ PM2 æœåŠ¡..."
                      pm2 restart nuxt-app || pm2 start ecosystem.config.js --name nuxt-app

                      echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰..."
                      ls -dt output_backup_* | tail -n +4 | xargs -r rm -rf
                      ls -dt node_modules_backup_* | tail -n +4 | xargs -r rm -rf

                      echo "âœ… éƒ¨ç½²å®Œæˆï¼"
                      pm2 status nuxt-app

name: Deploy to Aliyun Server with Docker

on:
    push:
        branches: [main, master]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: æ‰“åŒ…é¡¹ç›®æ–‡ä»¶
              run: |
                  tar --exclude='.git' \
                      --exclude='node_modules' \
                      --exclude='.output' \
                      --exclude='.nuxt' \
                      --exclude='.env' \
                      --exclude='data' \
                      --exclude='deploy.tar.gz' \
                      -czf deploy.tar.gz .

            - name: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶åˆ°æœåŠ¡å™¨
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  source: 'deploy.tar.gz'
                  target: '/tmp/'

            - name: ä½¿ç”¨ Docker éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  port: ${{ secrets.ALIYUN_PORT || 22 }}
                  script: |
                      cd ${{ secrets.DEPLOY_PATH }}
                      echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
                      rm -rf * .[^.]* 2>/dev/null || true
                      echo "ğŸ“¦ è§£å‹é¡¹ç›®æ–‡ä»¶..."
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz
                      echo "ğŸ“ åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
                      cat > .env << 'EOF'
                      NODE_ENV=production
                      HOST=0.0.0.0
                      PORT=3000
                      DATABASE_URL=${{ secrets.DATABASE_URL }}
                      REDIS_HOST=host.docker.internal
                      EOF
                      echo "ğŸ³ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
                      docker compose down 2>/dev/null || true
                      docker rm -f nuxt-app 2>/dev/null || true
                      echo "ğŸ—ï¸  æ„å»º Docker é•œåƒ..."
                      docker compose build --no-cache
                      echo "ğŸš€ å¯åŠ¨ Docker å®¹å™¨..."
                      docker compose up -d
                      echo "âœ… éƒ¨ç½²å®Œæˆï¼"
                      docker compose ps
                      echo "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼ˆæœ€å 20 è¡Œï¼‰ï¼š"
                      docker compose logs --tail=20
